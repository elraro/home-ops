apiVersion: batch/v1
kind: CronJob
metadata:
  name: recycle-pvs
  namespace: security
spec:
  schedule: "*/5 * * * *" # cada 5 minutos
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: default
          restartPolicy: OnFailure
          containers:
            - name: recycle
              image: registry.suse.com/suse/kubectl:1.33@sha256:73782a857611810b4222f3971663041e8c22b87ab44f12b0b2c5ba244fc5e452
              command:
                - /bin/sh
                - -c
                - |
                  for pv in $(kubectl get pv -o jsonpath='{.items[?(@.status.phase=="Released")].metadata.name}'); do
                    kubectl patch pv $pv -p '{"spec":{"claimRef": null}}'
                  done
